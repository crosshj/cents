<!DOCTYPE html>
<html
	lang="en"
	class="app-html"
>
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0"
		/>

		<!-- PWA Meta Tags -->
		<meta
			name="application-name"
			content="Cents"
		/>
		<meta
			name="apple-mobile-web-app-capable"
			content="yes"
		/>
		<meta
			name="apple-mobile-web-app-status-bar-style"
			content="default"
		/>
		<meta
			name="apple-mobile-web-app-title"
			content="Cents"
		/>
		<meta
			name="description"
			content="A personal finance management interface"
		/>
		<meta
			name="format-detection"
			content="telephone=no"
		/>
		<meta
			name="mobile-web-app-capable"
			content="yes"
		/>
		<meta
			name="msapplication-config"
			content="/browserconfig.xml"
		/>
		<meta
			name="msapplication-TileColor"
			content="#21b7b7"
		/>
		<meta
			name="msapplication-tap-highlight"
			content="no"
		/>

		<!-- Mobile browser UI color -->
		<meta
			name="theme-color"
			content="#21b7b7"
			id="theme-color-meta"
		/>
		<meta
			name="theme-color"
			media="(prefers-color-scheme: light)"
			content="#21b7b7"
		/>
		<meta
			name="theme-color"
			media="(prefers-color-scheme: dark)"
			content="#199898"
		/>

		<title>Cents</title>

		<!-- PWA Manifest -->
		<link
			rel="manifest"
			href="/manifest.json"
		/>

		<!-- Icons -->
		<link
			rel="icon"
			type="image/svg+xml"
			href="../images/cents-logo-flat.svg"
		/>

		<!-- font awesome -->
		<link
			rel="preload"
			as="style"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
			onload="this.rel='stylesheet'"
		/>
		<link
			rel="preload"
			as="style"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/v4-shims.min.css"
			onload="this.rel='stylesheet'"
		/>
		<link
			rel="preload"
			as="style"
			href="https://cdn.jsdelivr.net/npm/@crosshj/html-next@latest/dist/htmlNext.css"
			onload="this.rel='stylesheet'"
		/>
		<link
			rel="preload"
			as="style"
			href="./index.css"
			onload="this.rel='stylesheet'"
		/>
		<noscript>
			<link
				rel="stylesheet"
				href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
			/>
			<link
				rel="stylesheet"
				href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/v4-shims.min.css"
			/>
			<link
				rel="stylesheet"
				href="https://cdn.jsdelivr.net/npm/@crosshj/html-next@latest/dist/htmlNext.css"
			/>
			<link
				rel="stylesheet"
				href="./index.css"
			/>
		</noscript>

		<!-- theme dark/light -->
		<script>
			window.setTheme = function (themeMode) {
				const storedTheme = localStorage.getItem('theme-mode');

				// defaults
				if (!themeMode) {
					if (!storedTheme) {
						const prefersDark = window.matchMedia(
							'(prefers-color-scheme: dark)'
						).matches;
						themeMode = prefersDark ? 'dark' : 'light';
					} else {
						themeMode = storedTheme;
					}
				}

				// html class
				if (!document.documentElement.classList.contains(themeMode)) {
					document.documentElement.classList.remove('light');
					document.documentElement.classList.remove('dark');
					document.documentElement.classList.add(themeMode);
				}

				// localStorage
				if (storedTheme !== themeMode) {
					localStorage.setItem('theme-mode', themeMode);
				}

				// theme color meta
				const metaThemeColor =
					document.getElementById('theme-color-meta');
				if (metaThemeColor) {
					const newContent =
						themeMode === 'dark' ? '#199898' : '#21b7b7';
					if (metaThemeColor.getAttribute('content') !== newContent) {
						metaThemeColor.setAttribute('content', newContent);
					}
				}
			};
			// Initialize theme on page load
			window.setTheme();
		</script>
	</head>

	<!-- Fallback 404 template -->
	<template id="fallback404">
		<x-page>
			<x-navbar titleText="Page Not Found"></x-navbar>
			<x-content>
				<x-markdown>
					The page you're looking for doesn't exist or has been moved.
				</x-markdown>
				<x-box
					sx:mt="4"
					sx:display="flex"
					sx:gap="2"
					sx:justify-content="center"
				>
					<x-button
						href="/dashboard"
						variant="primary"
						label="Go to Dashboard"
					></x-button>
				</x-box>
			</x-content>
		</x-page>
	</template>

	<body>
		<x-data name="appContent"></x-data>
		<x-fragment
			class="app-content"
			contents="global_appContent"
			showLoading="true"
		></x-fragment>

		<script type="module">
			import {
				initializeFramework,
				SetData,
				GetData,
				Navigate,
				Router,
				Trigger,
			} from 'https://cdn.jsdelivr.net/npm/@crosshj/html-next@latest/dist/htmlNext.min.js';

			const fallback404 =
				document.getElementById('fallback404').innerHTML;
			const cache = new Map();
			const fetchPage = async (path) => {
				if (path === '404') {
					return fallback404;
				}
				if (cache.has(path)) return cache.get(path);
				try {
					const response = await fetch(`./pages/${path}`);
					const result = await response.text().then((x) => x.trim());
					if (!result.trim()) {
						throw new Error('Page not found');
					} else {
						cache.set(path, result.trim());
						return result.trim();
					}
				} catch (error) {
					console.error(`Failed to fetch page from ${path}:`, error);
					return fallback404;
				}
			};
			const fetchData = async (path, defaultValue = {}) => {
				if (cache.has(path)) return cache.get(path);
				try {
					const response = await fetch(`./data/${path}`);
					const result = await response.json();
					cache.set(path, result);
					return result;
				} catch (error) {
					console.error(`Failed to fetch JSON from ${path}:`, error);
					return defaultValue;
				}
			};
			const routerSetup = async () => {
				const initialHash = window.location.hash || '#/dashboard';
				const initialPath = initialHash.replace(/^#/, '');

				// Handle hash changes and browser back/forward
				const handleNavigation = async () => {
					SetData('mainContent', '');
					const newHash = window.location.hash || '#/dashboard';
					const newPath = newHash.replace(/^#/, '');
					await SetData('activePath', newPath);
					const content = await fetchPage(newPath.replace(/^\//, ''));
					await SetData('mainContent', content);
					document
						.querySelectorAll('.menuItem.active')
						.forEach((item) => {
							item.classList.remove('active');
						});
					const menuItems = document.querySelectorAll('.menuItem');
					for (const item of menuItems) {
						const href = item.getAttribute('href');
						if (!newPath.startsWith(href)) continue;
						item.classList.add('active');
					}
					document
						.getElementById('sidebar')
						?.classList?.remove('open');
				};

				window.addEventListener('hashchange', handleNavigation);

				const beforeEach = async (context) => {
					if (context.to.href === '/logout') {
						cache.clear();
						await Trigger('logout'); //defined in _app.html
						return false;
					}

					if (
						context.to.href ===
						window.location.hash.replace(/^#/, '')
					) {
						handleNavigation();
					} else {
						window.location.hash = context.to.path;
					}
				};

				const afterEach = async (context) => {};

				return Router({
					initialPath,
					beforeEach,
					afterEach,
				});
			};

			(async () => {
				const router = await routerSetup();
				const authToken = localStorage.getItem('authToken');
				const initialContent = await fetchPage(
					authToken ? '_app' : '_auth'
				);
				const menuItems = await fetchData('menu.json', []);
				const state = {
					appContent: initialContent,
					mainContent: '',
					menuItems,
					themeSettings: {
						mode: document.documentElement.classList.contains(
							'dark'
						)
							? 'dark'
							: 'light',
					},
					contentLoaded: false,
				};
				const hooks = {};
				await initializeFramework({ router, state, hooks });
				document.body.classList.add('framework-loaded');
			})();
		</script>
	</body>
</html>
